/*! co.blackagency.whatsnext 30-01-2016 */
"use strict";var c={keys:{parse:{ApplicationID:"6EGKiJSZgvWOGpzHdJsxDfTJgLCIwMCFrn9WnLF7",JavascriptKey:"OaY803d3UixwhcgxgTFn8Agl7vdLECMXepArLOiv"}}};_.templateSettings.variable="TD",Date.prototype.addHours=function(h){return this.setHours(this.getHours()+h),this},Date.prototype.subHours=function(h){return this.setHours(this.getHours()-h),this},Date.prototype.addMinutes=function(m){return this.setMinutes(this.getMinutes()+m),this},Date.prototype.subMinutes=function(m){return this.setMinutes(this.getMinutes()-m),this},Date.prototype.addSeconds=function(s){return this.setSeconds(this.getSeconds()+s),this},Date.prototype.subSeconds=function(s){return this.setSeconds(this.getSeconds()-s),this},Date.prototype.toUTC=function(){return moment&&this.setMinutes(this.getMinutes()+moment().utcOffset()),this},Number.prototype.format=function(n,x,s,c){var re="\\d(?=(\\d{"+(x||3)+"})+"+(n>0?"\\D":"$")+")",num=this.toFixed(Math.max(0,~~n));return(c?num.replace(".",c):num).replace(new RegExp(re,"g"),"$&"+(s||","))};var t={d1:new Date(14304564e5),d2:new Date(1427346e6)},meta={userP:{},userLastSyncAt:new Date(2e3,1,1),userAccounts:[],userAccountsLastSyncAt:new Date(2e3,1,1),deviceReady:!1,deviceOnline:!1},touch={addE:function(){return $.Deferred(function(f){$(".touchable").on("mousedown touchstart",function(){$(".touched").removeClass("touched"),$(this).addClass("touched")}),$(".touchable").on("mouseup touchend touchcancel",function(){$(".touched").removeClass("touched")}),f.resolve()}).promise()},remE:function(){return $.Deferred(function(f){$(".touchable").off("mousedown touchstart"),$(".touchable").off("mouseup touchend touchcancel"),f.resolve()}).promise()},initialize:function(){touch.remE().done(touch.addE)},reset:function(){touch.remE().done(touch.addE)}},app={initialize:function(){console.log("App init"),Parse.initialize(c.keys.parse.ApplicationID,c.keys.parse.JavascriptKey),app.bindEvents()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1),document.addEventListener("online",function(){meta.deviceOnline=!0},!1),document.addEventListener("offline",function(){meta.deviceOnline=!1},!1)},onDeviceReady:function(){console.log("Device is ready"),meta.deviceReady=!0,"ios"==device.platform.toLowerCase(),views.initialize(),touch.initialize()},l:function(content,type){var s="";"string"==typeof content?s=content:"object"==typeof content&&(s=JSON.stringify(content,null,"")),"undefined"==typeof type?console.log(s):1==type?console.log(s):2==type?console.warn(s):3==type&&console.error(s)}},views={initialize:function(screen){console.log("View init"),$("body").css("background-color","#000"),Parse.User.current()?Parse.User.current().fetch({success:function(r){views.screens.accounts.initialize()},error:function(e){console.error("Could not refresh User object, application aborted."),console.error(e),Parse.User.logOut(),views.screens.login.initialize()}}):views.screens.login.initialize()},screens:{login:{initialize:function(){app.l("Login screen INIT"),views.screens.login.remE().done(views.screens.login.addE().done(views.screens.login.render))},getData:function(){return $.Deferred(function(f){f.resolve()}).promise()},render:function(){return $.Deferred(function(f){$("screen#login").removeClass("hidden"),f.resolve()}).promise()},addE:function(){return $.Deferred(function(f){$("screen#login form#login").on("submit",function(e){$("screen#login #btn_login").prop("disabled",!0),Parse.User.logIn($("screen#login form#login #txt_username").val(),$("screen#login form#login #txt_password").val(),{success:function(user){app.l("Parse.User.logIn Success",2),views.initialize(),setTimeout(function(){$("screen#login #btn_login").prop("disabled",!1),$("screen#login form#login")[0].reset()},500)},error:function(error){switch(app.l("Parse.User.logIn Error",3),error.code){case 101:$("screen#login #feedback_login").html(strings.loginFail);default:console.error(error)}setTimeout(function(){$("screen#login #feedback_login").html(""),$("screen#login #btn_login").prop("disabled",!1)},3e3)}}),$("input, select, textarea, button").blur(),e.preventDefault()}),f.resolve()}).promise()},remE:function(){return $.Deferred(function(f){$("screen#login form#login").off("submit"),f.resolve()}).promise()}},signup:{initialize:function(){},getData:function(){},render:function(){},addE:function(){},remE:function(){}},accounts:{initialize:function(){views.screens.accounts.getData(!0).done(views.screens.accounts.render)},getData:function(forceDataUpdate){return"unknown"==typeof forceDataUpdate&&(forceDataUpdate=!1),$.Deferred(function(f){meta.userAccountsLastSyncAt<=(new Date).subHours(2)||forceDataUpdate?(app.l("Fetching accounts remotely",2),act.getAccounts().done(function(d){meta.userAccounts=d,meta.userAccountsLastSyncAt=new Date,f.resolve(d)}).fail(function(e){app.l(e,3),f.reject(e)})):(app.l("Fetching accounts from cache",2),f.resolve(meta.userAccounts))}).promise()},render:function(){return $.Deferred(function(f){var accountListItemTempalte=_.template($("#tpl_accountListItem").html());$("screen#accounts list").html(""),_.each(meta.userAccounts,function(o,i,a){$("screen#accounts list#accountsByBalance").append(accountListItemTempalte(o))}),_.each(_.sortBy(meta.userAccounts,function(i){return-i.get("whatsLeft")}),function(o,i,a){$("screen#accounts list#accountsByWhatsLeft").append(accountListItemTempalte(o))}),ui.tabs.check(),views.screens.accounts.remE().done(views.screens.accounts.addE),$("screen#accounts").removeClass("hidden"),f.resolve()}).promise()},addE:function(){return $.Deferred(function(f){touch.reset(),$("screen#accounts tab").hammer().on("tap",function(){$("screen#accounts tab").removeClass("active"),$(this).addClass("active"),ui.tabs.check()}),f.resolve()}).promise()},remE:function(){return $.Deferred(function(f){$("screen#accounts tab").hammer().off("tap"),f.resolve()}).promise()}},accountDetail:{initialize:function(){views.screens.accountDetail.getData(!0).done(views.screens.accountDetail.render)},getData:function(forceDataUpdate){return"unknown"==typeof forceDataUpdate&&(forceDataUpdate=!1),$.Deferred(function(f){act.getAccountDetails(forceDataUpdate).done(function(d){console.log(d),meta.userAccounts=d,meta.userAccountsLastSyncAt=new Date,f.resolve()}).fail(function(e){app.l(e,3),f.reject(e)}),f.resolve()}).promise()},render:function(){return $.Deferred(function(f){f.resolve()}).promise()},addE:function(){return $.Deferred(function(f){f.resolve()}).promise()},remE:function(){return $.Deferred(function(f){f.resolve()}).promise()}}}},temp={},util={buildFrequencyArray:function(firstDate,frequency,startMoment,endMoment){if("unknown"==typeof startMoment){app.l("No startMoment, setting default.",2);var startMoment=moment()}if("unknown"==typeof endMoment){app.l("No endMoment, setting default.",2);var endMoment=startMoment.add(2,"y")}switch(moment.isDate(firstDate)&&(firstDate=moment(firstDate)),console.log(startMoment),console.log(endMoment),frequency){case 1:var recurrence=moment().recur({start:startMoment,end:endMoment}).every(firstDate.date()).daysOfMonth().every(firstDate.month()).monthsOfYear();console.log(recurrence.endDate(moment().add(2,"y")).all()),temp.r=recurrence;break;case 2:break;case 4:break;case 6:break;case 12:break;case 24:break;case 26:break;case 52:break;case 365:}},nextOccurrence:function(date,frequency){var now=moment(),then=moment(date),next=moment({year:1999,month:11,date:31,hour:23,minute:59,second:59,millisecond:0});switch(frequency){case 1:next=now.date()>then.month()||now.month()==then.month()&&now.date()>then.date()?moment({year:now.year(),month:then.month(),date:then.date(),hour:23,minute:59,second:59,millisecond:0}).add(1,"y"):moment({year:now.year(),month:then.month(),date:then.date(),hour:23,minute:59,second:59,millisecond:0});break;case 2:var month1=0;month1=then.month()>=6?then.month()-6:then.month();var month2=month1+6,oc1=moment({year:now.year(),month:month1,date:then.date(),hour:23,minute:59,second:59,millisecond:0}),oc2=moment({year:now.year(),month:month2,date:then.date(),hour:23,minute:59,second:59,millisecond:0});next=moment(now).isAfter(oc1)?oc2:oc1;break;case 4:var month1=0;month1=then.month()>=3?then.month()-3:then.month();var month2=month1+3,month3=month2+3,month4=month3+3,oc1=moment({year:now.year(),month:month1,date:then.date(),hour:23,minute:59,second:59,millisecond:0}),oc2=moment({year:now.year(),month:month2,date:then.date(),hour:23,minute:59,second:59,millisecond:0});moment({year:now.year(),month:month3,date:then.date(),hour:23,minute:59,second:59,millisecond:0}),moment({year:now.year(),month:month4,date:then.date(),hour:23,minute:59,second:59,millisecond:0});next=moment(now).isAfter(oc1)?oc2:oc1;break;case 12:moment();then.date()>=now.date()?(next=moment({year:now.year(),month:now.month(),date:then.date(),hour:23,minute:59,second:59,millisecond:0}),console.log(next.fromNow()),console.log(next.format("llll"))):(next=moment({year:now.year(),month:now.month(),date:then.date(),hour:23,minute:59,second:59,millisecond:0}).add(1,"M"),console.log(next.fromNow()),console.log(next.format("llll")))}return next}},act={getAccounts:function(){return $.Deferred(function(aGetAcc){var Account=Parse.Object.extend("Account"),accountsQuery=new Parse.Query(Account);accountsQuery.ascending("name"),accountsQuery.find({success:function(results){app.l("Successfully retrieved "+results.length+" accounts for current user",2),_.each(results,function(o,i,a){var Bill=Parse.Object.extend("Bill"),billsQuery=new Parse.Query(Bill);billsQuery.equalTo("Account",o),billsQuery.find({success:function(bills){o.bills=bills},error:function(error){app.l("Error retrieving Bills",3),aGetAcc.reject(error)}});var Deposit=Parse.Object.extend("Deposit"),depositsQuery=new Parse.Query(Deposit);depositsQuery.equalTo("Account",o),depositsQuery.find({success:function(deposits){o.deposits=deposits},error:function(error){app.l("Error retrieving Deposits",3),aGetAcc.reject(error)}})}),aGetAcc.resolve(results)},error:function(error){aGetAcc.reject(error)}})}).promise()},getAccountDetails:function(){return $.Deferred(function(aGetAcc){var Account=Parse.Object.extend("Account"),accountsQuery=new Parse.Query(Account);accountsQuery.ascending("name"),accountsQuery.find({success:function(results){app.l("Successfully retrieved "+results.length+" accounts for current user",2),aGetAcc.resolve(results)},error:function(error){aGetAcc.reject(error)}})}).promise()}},ui={tabs:{check:function(){$("screen .tab-target").addClass("hidden"),$("screen tab.active").each(function(){$("#"+$(this).data("for")+".tab-target").removeClass("hidden")})}}},calc={wl:function(accountID){var updateAll=!1;"unknown"==typeof accountID&&(updateAll=!0),_.each(meta.userAccounts,function(o,i,a){!updateAll&&accountID==o.id||updateAll})}};